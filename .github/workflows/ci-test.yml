name: "CI Test"

on:
  push:
    branches: [master]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [master]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
  schedule:
    - cron: "21 11 * * 0"

jobs:
  ci:
    name: CI test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: jirutka/setup-alpine@v1
        with:
          branch: v3.18
          packages: >
            nodejs npm git tini gcc g++ make musl-dev cargo python3 py3-pip python3-dev postfix postfix-pcre

      - name: Setup Node.js & python
        run: |
          npm install -g node-gyp yarn
          python -V
        shell: alpine.sh --root {0}

      - name: Install dependencies into Alpine and run test
        run: |
          cd opencti-platform/opencti-front
          yarn install
          yarn build
          yarn lint
          yarn check-ts
          yarn test
          yarn test:e2e
          cd ../opencti-graphql
          yarn install
          yarn build
          yarn lint
          yarn check-ts
          yarn test:dev
        shell: alpine.sh {0}
